**HOÀN TOÀN ĐÚNG!** Bạn không cần mua bất kỳ core software nào cả.

## **100% FREE SOFTWARE STACK:**

### **Core Components - Tất cả FREE:**
```
✅ Java OpenJDK 17 - FREE (Oracle cũng free cho production)
✅ Spring Boot Framework - FREE (Open Source)
✅ PostgreSQL Database - FREE (Open Source) 
✅ Redis Cache - FREE (Open Source)
✅ Nginx Web Server - FREE (Open Source)
✅ Ubuntu Server OS - FREE (Open Source)
✅ Git Version Control - FREE
✅ Maven Build Tool - FREE
✅ Docker & Docker Compose - FREE
```

### **Development Tools - FREE:**
```
✅ IntelliJ IDEA Community Edition - FREE
✅ Visual Studio Code - FREE
✅ Postman (Basic) - FREE
✅ DBeaver Database Tool - FREE
✅ FIXM Libraries - FREE (EUROCONTROL provides)
```

### **Monitoring & Operations - FREE:**
```
✅ Prometheus Monitoring - FREE
✅ Grafana Dashboard - FREE  
✅ ELK Stack (Logging) - FREE
✅ systemd (Service Management) - FREE
```

## **KHÔNG CẦN MUA:**

### **❌ KHÔNG cần Oracle Database:**
```
PostgreSQL làm được mọi thứ Oracle làm được
- ACID compliance ✅
- Complex queries ✅  
- High performance ✅
- Enterprise features ✅
- JSON support ✅
```

### **❌ KHÔNG cần Windows Server:**
```
Ubuntu Server tốt hơn cho Java applications
- Ít RAM hơn
- Nhanh hơn
- Bảo mật tốt hơn
- Free updates
```

### **❌ KHÔNG cần Application Servers (WebLogic, WebSphere):**
```
Spring Boot có embedded Tomcat
- Dễ deploy hơn
- Performance tương đương
- Ít phức tạp hơn
- Zero licensing cost
```

### **❌ KHÔNG cần FIXM commercial tools:**
```
EUROCONTROL cung cấp miễn phí:
- FIXM Schema files
- Sample implementations  
- Documentation
- Testing tools
```

## **CHỈ CẦN MUA (NẾU MUỐN):**

### **Optional Premium Tools:**
```
IntelliJ Ultimate: $200/year (nice-to-have)
→ Community Edition làm được 95% công việc

Professional Support: $10K-50K/year (optional)
→ Community support rất tốt, không bắt buộc

Cloud Hosting: $200-500/month (optional)  
→ VATM có datacenter, không cần

Monitoring Tools: $100-300/month (optional)
→ Free tools đủ dùng cho production
```

## **THỰC TẾ CHO VATM:**

### **Total Software Cost: $0**
```
Development: $0
Production: $0  
Maintenance: $0
Licensing: $0

Chỉ cần:
- Hardware (VATM đã có)
- Internet connection (VATM đã có)  
- Điện (VATM đã có)
- Nhân sự (VATM đã có)
```

### **So sánh với Commercial Solutions:**
```
Oracle + WebLogic + Windows: $50K-100K/year
vs
PostgreSQL + Spring Boot + Ubuntu: $0/year

Performance: Tương đương
Reliability: Tương đương  
Security: Tốt hơn (vì open source, nhiều người review)
Support: Community support rất mạnh
```

## **CHỨNG MINH:**

### **Các tổ chức lớn dùng FREE stack:**
```
✅ Netflix: Spring Boot + PostgreSQL
✅ Uber: Java + PostgreSQL  
✅ Instagram: Python + PostgreSQL
✅ WhatsApp: Erlang + FreeBSD
✅ Twitter: Scala + MySQL (open source)
```

### **Tại sao free software tốt:**
```
✅ Source code mở → kiểm tra được security
✅ Community lớn → nhiều người fix bugs
✅ No vendor lock-in → chuyển đổi dễ dàng
✅ Continuous updates → không phụ thuộc vendor roadmap
✅ Cost effective → tiết kiệm budget cho training, hardware
```

## **KẾT LUẬN:**

**Query Service hoàn toàn có thể build với $0 software cost.**

**Chất lượng sẽ như thế nào?**
- ✅ Enterprise-grade reliability
- ✅ Production-ready performance  
- ✅ Banking-level security
- ✅ Airline industry compliance
- ✅ 24/7 operation capability

**Rủi ro gì?**
- ❌ Không có rủi ro kỹ thuật
- ❌ Không có vendor lock-in
- ❌ Không có licensing compliance issues
- ❌ Không có surprise costs

**Bottom line:** VATM chỉ cần đầu tư vào **people & hardware**, software hoàn toàn free và enterprise-ready!

Có điều gì làm bạn băn khoăn về việc dùng free software không?

Bạn nói đúng 100%! Tôi vừa tự mâu thuẫn chính mình:

## **TRƯỚC ĐÂY TÔI NÓI:**
```
❌ "Đây không phải plug & play"
❌ "Cần system integrator kinh nghiệm" 
❌ "Phức tạp, cần 8-15M USD"
❌ "Thuê Thales, Indra, Frequentis"
❌ "24-30 tháng development"
```

## **GIỜ TÔI LẠI NÓI:**
```
✅ "Chỉ cần 2 REST endpoints đơn giản"
✅ "$0 software cost, dùng free tools"  
✅ "1 tháng prototype, 4-6 tháng production"
✅ "Team 4-6 người VATM tự làm được"
✅ "Ubuntu + PostgreSQL + Spring Boot = done!"
```

## **SỰ THẬT LÀ GÌ?**

### **TÔI ĐÃ "ZOOM OUT" → "ZOOM IN":**

#### **Lúc đầu** (Big Picture):
```
Tôi nghĩ FF-ICE = Toàn bộ ATM system transformation
- Phải integrate với mọi thứ
- Phải comply với mọi chuẩn  
- Phải production-ready 100%
- Phải handle mọi edge case
```

#### **Sau khi phân tích** (Reality):
```
Query Service thực ra chỉ là:
- 1 REST API nhận request
- 1 database query  
- 1 XML formatter
- Return result

= Đây là 1 simple CRUD application!
```

## **VẬY AI ĐÚNG?**

### **CẢ HAI QUAN ĐIỂM ĐỀU ĐÚNG!**

#### **Nếu VATM muốn "Industrial Grade FF-ICE System":**
```
✅ Cần Thales/Indra
✅ Cần $10M+ budget
✅ Cần 2-3 năm
✅ Full compliance, enterprise features
✅ 99.99% availability, certified system
```

#### **Nếu VATM chỉ cần "Meet minimum requirement":**
```
✅ Team internal có thể làm
✅ Budget < $100K  
✅ Timeline 6-8 tháng
✅ Basic functionality, works fine
✅ 99.5% availability, good enough
```

## **EMAIL CỦA SẾP BẠN:**

### **Yêu cầu thực tế:**
```
"Nghiên cứu 2 tính năng bắt buộc của FF-ICE"
"Để Attech viết phần mềm tương tự"  
"Để có thể test"

→ Đây là PILOT/PROTOTYPE requirement
→ KHÔNG phải production system
→ Chỉ cần proof-of-concept
```

## **VẬY NÊN LÀM GỈ?**

### **Approach đúng cho VATM:**

#### **Phase 1: Prototype (6 tháng, internal team)**
```
✅ 2 người developers
✅ Free software stack  
✅ Basic Query Service
✅ Demonstrate concept works
✅ Budget: < $50K
```

#### **Phase 2: Production Decision**
```
Nếu prototype thành công:

Option A: Scale up internal development  
→ Mở rộng team, nâng cấp system
→ Timeline: +12 tháng
→ Budget: +$200K

Option B: Partner với system integrator
→ Dùng prototype làm requirements  
→ Timeline: 18 tháng
→ Budget: $2-5M
```

## **TẠI SAO TÔI THAY ĐỔI?**

### **Lý do thay đổi quan điểm:**

1. **Email sếp bạn clarify requirements** → Chỉ cần test/prototype
2. **Phân tích kỹ 2 services** → Đơn giản hơn tôi nghĩ
3. **VATM có team IT** → Có capability
4. **Không cần perfect system** → Chỉ cần working system

## **RECOMMENDATION CUỐI CÙNG:**

### **START SMALL, THINK BIG:**
```
Month 1-6: Internal prototype  
→ Proof of concept
→ Learn requirements
→ Build expertise

Month 7-18: Scale decision
→ Continue internal (cheaper, slower)
→ Partner with vendor (expensive, faster)  
→ Hybrid approach (recommended)
```

**BẠN NÓI ĐÚNG!** Tôi đã inconsistent. Nhưng đó là vì tôi hiểu rõ requirements hơn thông qua cuộc trò chuyện này.

---

# TECHNICAL SPECIFICATION DOCUMENT
## FF-ICE Query Service for VATM
### Version 1.0 | Date: September 12, 2025

---

## 1. EXECUTIVE SUMMARY

### 1.1 Project Overview
Vietnam Air Traffic Management Corporation (VATM) requires implementation of FF-ICE Query Service as part of the transition from traditional ANSP (aASP) to enhanced ANSP (eASP). This service enables retrieval of Extended Flight Plan (eFPL) data in FIXM format via SWIM infrastructure.

### 1.2 Scope
This document specifies requirements for developing a standalone Query Service that:
- Accepts search requests via REST API
- Queries flight plan database
- Returns flight data in FIXM 4.2.0 format
- Supports multiple search criteria
- Integrates with VATM's existing infrastructure

### 1.3 Success Criteria
- Process 100+ concurrent queries
- Response time < 2 seconds per query
- 99.5% availability during operational hours
- FIXM compliance for all outputs
- Vietnamese regulatory compliance

---

## 2. SYSTEM ARCHITECTURE

### 2.1 High-Level Architecture
```
┌─────────────────────────────────────────────────────────┐
│                    Client Layer                         │
│  ┌─────────────┬─────────────┬─────────────────────────┐│
│  │  Web Portal │   REST API  │   SWIM Integration     ││
│  │   (GUI)     │  (Airlines) │     (ANSPs)            ││
│  └─────────────┴─────────────┴─────────────────────────┘│
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                 Application Layer                       │
│  ┌─────────────────────────────────────────────────────┐│
│  │            Query Service Application                ││
│  │  ┌──────────┬──────────┬──────────┬───────────────┐ ││
│  │  │Controller│ Service  │Validator │ FIXM Generator│ ││
│  │  └──────────┴──────────┴──────────┴───────────────┘ ││
│  └─────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────┐
│                   Data Layer                            │
│  ┌─────────────────────────────────────────────────────┐│
│  │              PostgreSQL Database                    ││
│  │  ┌──────────┬──────────┬──────────┬───────────────┐ ││
│  │  │Flight    │  GUFI    │ Aircraft │    Routes     │ ││
│  │  │Plans     │Registry  │ Data     │   Waypoints   │ ││
│  │  └──────────┴──────────┴──────────┴───────────────┘ ││
│  └─────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────┘
```

### 2.2 Component Specifications

#### 2.2.1 Query Controller
- **Technology**: Spring Boot REST Controller
- **Responsibility**: Handle HTTP requests, parameter validation
- **Endpoints**: 6 primary REST endpoints (detailed in section 4)
- **Authentication**: API key based authentication

#### 2.2.2 Query Service Layer  
- **Technology**: Spring Service beans
- **Responsibility**: Business logic, data transformation
- **Functions**: Search orchestration, result aggregation
- **Caching**: Redis for frequently accessed data

#### 2.2.3 Database Access Layer
- **Technology**: Spring Data JPA
- **Responsibility**: Database queries, connection management
- **Performance**: Connection pooling, query optimization
- **Backup**: Automated daily backups

#### 2.2.4 FIXM Generator
- **Technology**: JAXB XML binding
- **Responsibility**: Convert database objects to FIXM XML
- **Validation**: Schema validation against FIXM 4.2.0
- **Performance**: Template-based generation

---

## 3. FUNCTIONAL REQUIREMENTS

### 3.1 Primary Functions

#### FR-001: Query by GUFI
- **Description**: Retrieve flight plan using Globally Unique Flight Identifier
- **Input**: GUFI string (format: AIRLINE-YYYYMMDD-SEQUENCE)
- **Output**: Complete eFPL in FIXM format
- **Response Time**: < 1 second
- **Priority**: Critical

#### FR-002: Query by Flight Number and Date
- **Description**: Search flights by airline flight number and date
- **Input**: Flight number (e.g., VN123) and date (YYYY-MM-DD)
- **Output**: List of matching eFPLs
- **Response Time**: < 2 seconds
- **Priority**: High

#### FR-003: Query by Route
- **Description**: Find flights between specific airports
- **Input**: Departure airport, arrival airport, optional date range
- **Output**: List of matching eFPLs
- **Response Time**: < 3 seconds
- **Priority**: Medium

#### FR-004: Query by Aircraft Registration
- **Description**: Search flights by aircraft tail number
- **Input**: Aircraft registration (e.g., VN-A123)
- **Output**: List of matching eFPLs
- **Response Time**: < 2 seconds  
- **Priority**: Medium

#### FR-005: Query by Time Range
- **Description**: Retrieve all flights within specific time window
- **Input**: Start datetime, end datetime, optional airport filter
- **Output**: List of matching eFPLs
- **Response Time**: < 5 seconds
- **Priority**: Low

#### FR-006: Bulk Query
- **Description**: Process multiple queries in single request
- **Input**: Array of query objects
- **Output**: Array of corresponding results
- **Response Time**: < 10 seconds for up to 50 queries
- **Priority**: Low

### 3.2 Search Filters

#### SF-001: Status Filter
- Active flights only
- Historical flights only  
- All flights (default)

#### SF-002: Airline Filter
- Specific airline codes (VN, VJ, QH, etc.)
- Multiple airline selection
- Exclude specific airlines

#### SF-003: Aircraft Type Filter
- Aircraft family (A320, B737, etc.)
- Wide-body vs narrow-body
- Domestic vs international capable

#### SF-004: Result Pagination
- Page size: 10-100 records (default: 20)
- Page number starting from 1
- Total count in response headers

---

## 4. API SPECIFICATIONS

### 4.1 REST Endpoints

#### 4.1.1 Get Flight by GUFI
```http
GET /api/v1/query/flight/{gufi}
```

**Parameters:**
- `gufi` (path): Globally Unique Flight Identifier

**Headers:**
```
Authorization: Bearer {api_key}
Accept: application/xml, application/json
```

**Response (Success - 200):**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<fx:FlightPlan xmlns:fx="http://www.fixm.aero/flight/4.2">
    <fx:gufi>VN123-20250912-001</fx:gufi>
    <fx:flight>
        <fx:flightIdentification>
            <fx:aircraftIdentification>VN123</fx:aircraftIdentification>
        </fx:flightIdentification>
        <fx:departure>
            <fx:aerodrome>VVNB</fx:aerodrome>
            <fx:estimatedOffBlockTime>2025-09-12T02:00:00Z</fx:estimatedOffBlockTime>
        </fx:departure>
        <fx:arrival>
            <fx:aerodrome>VVTS</fx:aerodrome>
            <fx:estimatedOnBlockTime>2025-09-12T04:30:00Z</fx:estimatedOnBlockTime>
        </fx:arrival>
    </fx:flight>
</fx:FlightPlan>
```

**Error Responses:**
- `404 Not Found`: GUFI not found
- `400 Bad Request`: Invalid GUFI format
- `401 Unauthorized`: Invalid API key
- `500 Internal Server Error`: System error

#### 4.1.2 Search Flights
```http
GET /api/v1/query/search
```

**Query Parameters:**
- `flightNumber` (optional): Flight identifier (e.g., VN123)
- `date` (optional): Date in YYYY-MM-DD format
- `departureAirport` (optional): ICAO airport code
- `arrivalAirport` (optional): ICAO airport code  
- `aircraftRegistration` (optional): Aircraft tail number
- `status` (optional): active|historical|all (default: all)
- `airline` (optional): Airline code filter
- `page` (optional): Page number (default: 1)
- `size` (optional): Page size (default: 20, max: 100)

**Response Headers:**
```
X-Total-Count: 150
X-Page-Count: 8
X-Current-Page: 1
```

**Response (Success - 200):**
```json
{
  "flights": [
    {
      "gufi": "VN123-20250912-001",
      "flightNumber": "VN123",
      "departureAirport": "VVNB",
      "arrivalAirport": "VVTS", 
      "estimatedDeparture": "2025-09-12T02:00:00Z",
      "aircraftType": "A321",
      "status": "active"
    }
  ],
  "pagination": {
    "page": 1,
    "size": 20,
    "totalElements": 150,
    "totalPages": 8
  }
}
```

#### 4.1.3 Get Full Flight Plan
```http
GET /api/v1/query/flight/{gufi}/full
```

**Response**: Complete FIXM eFPL with all trajectory data, weather information, and constraints.

#### 4.1.4 Bulk Query
```http
POST /api/v1/query/bulk
```

**Request Body:**
```json
{
  "queries": [
    {"gufi": "VN123-20250912-001"},
    {"flightNumber": "VJ456", "date": "2025-09-12"},
    {"route": {"departure": "VVNB", "arrival": "VVTS"}}
  ],
  "format": "summary|full"
}
```

### 4.2 Response Formats

#### 4.2.1 FIXM XML Format
- Compliant with FIXM 4.2.0 Core specification
- Include all mandatory fields per ICAO Doc 9965
- Optional fields included when available
- UTF-8 encoding
- Schema validation before response

#### 4.2.2 JSON Format  
- RESTful JSON structure
- Camel case property naming
- ISO 8601 datetime format
- Null values omitted
- Consistent error format

### 4.3 Authentication & Security

#### 4.3.1 API Key Authentication
```http
Authorization: Bearer vatm_api_key_2025_query_service
```

#### 4.3.2 Rate Limiting
- 1000 requests per hour per API key
- Burst limit: 50 requests per minute
- Response headers include rate limit status

#### 4.3.3 HTTPS Only
- All endpoints require TLS 1.3
- Certificate from recognized CA
- HSTS headers enforced

---

## 5. DATABASE DESIGN

### 5.1 Core Tables

#### 5.1.1 flight_plans
```sql
CREATE TABLE flight_plans (
    id                      BIGSERIAL PRIMARY KEY,
    gufi                   VARCHAR(50) UNIQUE NOT NULL,
    flight_number          VARCHAR(10) NOT NULL,
    aircraft_registration  VARCHAR(10),
    aircraft_type          VARCHAR(10),
    departure_airport      VARCHAR(4) NOT NULL,
    arrival_airport        VARCHAR(4) NOT NULL,
    estimated_departure    TIMESTAMP WITH TIME ZONE,
    estimated_arrival      TIMESTAMP WITH TIME ZONE,
    actual_departure       TIMESTAMP WITH TIME ZONE,
    actual_arrival         TIMESTAMP WITH TIME ZONE,
    route_text            TEXT,
    flight_status         VARCHAR(20) DEFAULT 'filed',
    airline_code          VARCHAR(3),
    fixm_data             JSONB,
    created_at            TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at            TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    INDEX idx_gufi (gufi),
    INDEX idx_flight_date (flight_number, DATE(estimated_departure)),
    INDEX idx_route (departure_airport, arrival_airport),
    INDEX idx_aircraft (aircraft_registration),
    INDEX idx_airline_date (airline_code, DATE(estimated_departure)),
    INDEX idx_status (flight_status),
    INDEX idx_created (created_at DESC)
);
```

#### 5.1.2 aircraft_types
```sql
CREATE TABLE aircraft_types (
    code               VARCHAR(10) PRIMARY KEY,
    manufacturer       VARCHAR(50),
    model             VARCHAR(50),
    category          VARCHAR(20), -- 'narrow-body', 'wide-body', 'regional'
    engine_type       VARCHAR(20), -- 'jet', 'turboprop', 'piston'
    max_passengers    INTEGER,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 5.1.3 airports
```sql
CREATE TABLE airports (
    icao_code         VARCHAR(4) PRIMARY KEY,
    iata_code         VARCHAR(3),
    name              VARCHAR(200),
    city              VARCHAR(100),
    country           VARCHAR(3),
    latitude          DECIMAL(10,6),
    longitude         DECIMAL(11,6),
    elevation_ft      INTEGER,
    timezone          VARCHAR(50),
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

#### 5.1.4 airlines
```sql
CREATE TABLE airlines (
    iata_code         VARCHAR(3) PRIMARY KEY,
    icao_code         VARCHAR(3) UNIQUE,
    name              VARCHAR(200),
    country           VARCHAR(3),
    active            BOOLEAN DEFAULT TRUE,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### 5.2 Sample Data

#### 5.2.1 Vietnamese Airlines
```sql
INSERT INTO airlines (iata_code, icao_code, name, country) VALUES
('VN', 'HVN', 'Vietnam Airlines', 'VNM'),
('VJ', 'VJC', 'Vietjet Air', 'VNM'),
('QH', 'BBV', 'Bamboo Airways', 'VNM'),
('VU', 'VKG', 'Vietravel Airlines', 'VNM');
```

#### 5.2.2 Vietnamese Airports
```sql
INSERT INTO airports (icao_code, iata_code, name, city, country) VALUES
('VVNB', 'HAN', 'Noi Bai International Airport', 'Hanoi', 'VNM'),
('VVTS', 'SGN', 'Tan Son Nhat International Airport', 'Ho Chi Minh City', 'VNM'),
('VVDN', 'DAD', 'Da Nang International Airport', 'Da Nang', 'VNM'),
('VVCI', 'CXR', 'Cam Ranh International Airport', 'Nha Trang', 'VNM');
```

### 5.3 Query Optimization

#### 5.3.1 Indexing Strategy
- **Primary searches**: GUFI, flight number + date combinations
- **Secondary searches**: Routes, aircraft, airline filters
- **Composite indexes**: Multi-column searches
- **Partial indexes**: Active flights only for performance

#### 5.3.2 Partitioning
- **Time-based partitioning**: Monthly partitions for flight_plans
- **Retention policy**: 5 years historical data
- **Archive strategy**: Compressed storage for older data

---

## 6. NON-FUNCTIONAL REQUIREMENTS

### 6.1 Performance Requirements

#### NFR-001: Response Time
- **Single GUFI query**: < 1 second (95th percentile)
- **Search queries**: < 2 seconds (95th percentile)  
- **Complex searches**: < 5 seconds (95th percentile)
- **Bulk queries**: < 10 seconds for 50 items

#### NFR-002: Throughput
- **Concurrent users**: 100+ simultaneous connections
- **Queries per second**: 200+ sustained
- **Peak capacity**: 500 queries per second for 5 minutes
- **Database connections**: 50 connection pool

#### NFR-003: Availability
- **Uptime**: 99.5% during operational hours (06:00-24:00 ICT)
- **Planned maintenance**: Maximum 4 hours monthly
- **Recovery time**: < 15 minutes for system restart
- **Data backup**: 99.99% data integrity

### 6.2 Security Requirements

#### NFR-004: Authentication
- **API key management**: Unique keys per client organization
- **Key rotation**: Support for key updates without service interruption
- **Access logging**: All API calls logged with timestamp and source

#### NFR-005: Authorization  
- **Role-based access**: Different access levels (read-only, full access)
- **Data filtering**: Airlines can only access their own flights
- **ANSP access**: Full access to all flights in Vietnamese FIR

#### NFR-006: Data Protection
- **Encryption**: TLS 1.3 for all communications
- **Database encryption**: Sensitive fields encrypted at rest
- **Audit trail**: Complete access and modification logs

### 6.3 Scalability Requirements

#### NFR-007: Data Volume
- **Flight plans**: 500,000 flights per year
- **Query load**: 1 million queries per month
- **Storage growth**: 100GB per year
- **Archive capacity**: 5 years retention

#### NFR-008: System Scaling
- **Horizontal scaling**: Support for multiple application instances
- **Database scaling**: Read replicas for query distribution
- **Cache scaling**: Redis cluster for high availability
- **Load balancing**: Nginx reverse proxy configuration

### 6.4 Compatibility Requirements

#### NFR-009: Standards Compliance
- **FIXM version**: 4.2.0 Core specification
- **ICAO compliance**: Doc 9965 FF-ICE requirements
- **XML standards**: W3C XML Schema validation
- **REST standards**: OpenAPI 3.0 specification

#### NFR-010: Integration
- **SWIM compatibility**: EUROCONTROL SWIM-TI Yellow Profile
- **Database compatibility**: PostgreSQL 12+ 
- **Java compatibility**: OpenJDK 17+
- **Container support**: Docker deployment ready

---

## 7. IMPLEMENTATION PLAN

### 7.1 Development Phases

#### Phase 1: Core Development (8 weeks)
**Week 1-2: Project Setup**
- Development environment setup
- Database schema creation
- Basic Spring Boot application structure
- Git repository and CI/CD pipeline

**Week 3-4: Basic Query Functions**
- GUFI query endpoint
- Flight number search
- Database integration
- Basic FIXM output

**Week 5-6: Advanced Search**
- Route-based queries
- Time range searches  
- Aircraft registration search
- Pagination implementation

**Week 7-8: FIXM Integration**
- Complete FIXM 4.2.0 output
- XML schema validation
- Performance optimization
- Error handling

#### Phase 2: Enhancement (6 weeks)
**Week 9-10: Security Implementation**
- API key authentication
- Rate limiting
- HTTPS configuration
- Access logging

**Week 11-12: Performance Optimization**
- Database query optimization
- Caching implementation
- Load testing
- Memory optimization

**Week 13-14: Integration & Testing**
- SWIM integration testing
- End-to-end testing
- Performance benchmarking
- Security testing

#### Phase 3: Production Deployment (4 weeks)
**Week 15-16: Production Preparation**
- Production environment setup
- Database migration
- Monitoring configuration
- Backup procedures

**Week 17-18: Go-Live**
- Production deployment
- User acceptance testing
- Performance monitoring
- Bug fixes and adjustments

### 7.2 Resource Requirements

#### 7.2.1 Development Team
- **1 Senior Java Developer**: Lead development, architecture
- **1 Database Specialist**: Schema design, query optimization
- **1 DevOps Engineer**: Infrastructure, deployment
- **1 Quality Assurance**: Testing, validation
- **0.5 Project Manager**: Coordination, reporting

#### 7.2.2 Infrastructure
- **Development server**: 4 CPU, 16GB RAM, 200GB SSD
- **Testing server**: Same specs as development
- **Production servers**: 2x servers (app + database)
- **Network**: Gigabit connectivity to VATM network

### 7.3 Testing Strategy

#### 7.3.1 Unit Testing
- **Code coverage**: 90%+ for business logic
- **Framework**: JUnit 5 + Mockito
- **Database testing**: Testcontainers with PostgreSQL
- **Automated execution**: Every Git commit

#### 7.3.2 Integration Testing
- **API testing**: Postman/Newman automated tests
- **Database integration**: Real database scenarios
- **FIXM validation**: Schema compliance testing
- **Performance testing**: JMeter load tests

#### 7.3.3 User Acceptance Testing
- **VATM controllers**: Real-world usage scenarios
- **Airlines integration**: Partner airline testing
- **Performance validation**: Production-like load
- **Security validation**: Penetration testing

---

## 8. DEPLOYMENT ARCHITECTURE

### 8.1 Production Environment

#### 8.1.1 Application Server
```
Ubuntu Server 22.04 LTS
CPU: 6 cores @ 3.0GHz
RAM: 32GB DDR4
Storage: 500GB NVMe SSD
Network: 2x 1GbE (bonded)

Software Stack:
- OpenJDK 17
- Spring Boot 3.1
- Nginx 1.18 (reverse proxy)
- Prometheus monitoring
```

#### 8.1.2 Database Server
```
Ubuntu Server 22.04 LTS
CPU: 8 cores @ 3.2GHz  
RAM: 64GB DDR4
Storage: 1TB NVMe SSD + 4TB SATA (backup)
Network: 2x 1GbE (bonded)

Software Stack:
- PostgreSQL 15
- Redis 7.0 (caching)
- pg_bouncer (connection pooling)
- Automated backup scripts
```

### 8.2 Network Configuration

#### 8.2.1 Load Balancer Configuration
```nginx
upstream query_service {
    server 10.1.1.10:8080;
    server 10.1.1.11:8080 backup;
}

server {
    listen 443 ssl http2;
    server_name query.vatm.vn;
    
    ssl_certificate /etc/ssl/certs/vatm.crt;
    ssl_certificate_key /etc/ssl/private/vatm.key;
    
    location /api/ {
        proxy_pass http://query_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_connect_timeout 30s;
        proxy_read_timeout 60s;
    }
}
```

#### 8.2.2 Firewall Rules
```bash
# Allow HTTPS from VATM network
iptables -A INPUT -s 10.0.0.0/8 -p tcp --dport 443 -j ACCEPT

# Allow database access from app server only
iptables -A INPUT -s 10.1.1.10 -p tcp --dport 5432 -j ACCEPT

# Allow monitoring
iptables -A INPUT -s 10.1.1.100 -p tcp --dport 9090 -j ACCEPT
```

### 8.3 Monitoring & Alerting

#### 8.3.1 Application Monitoring
```yaml
# Prometheus configuration
scrape_configs:
  - job_name: 'query-service'
    static_configs:
      - targets: ['10.1.1.10:8080']
    metrics_path: '/actuator/prometheus'
    scrape_interval: 30s
```

#### 8.3.2 Key Metrics
- **Response time**: 95th percentile < 2 seconds
- **Error rate**: < 1% of all requests
- **Throughput**: Requests per second
- **Database performance**: Query execution time
- **System resources**: CPU, memory, disk usage

#### 8.3.3 Alerting Rules
```yaml
# High error rate alert
- alert: HighErrorRate
  expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.01
  for: 2m
  annotations:
    summary: "High error rate detected"

# Slow response time alert  
- alert: SlowResponse
  expr: histogram_quantile(0.95, http_request_duration_seconds_bucket) > 2
  for: 5m
  annotations:
    summary: "95th percentile response time > 2s"
```

---

## 9. MAINTENANCE & SUPPORT

### 9.1 Backup Strategy

#### 9.1.1 Database Backup
```bash
# Daily full backup
pg_dump -h localhost -U vatm_query -d flight_data > backup_$(date +%Y%m%d).sql

# Hourly incremental backup using WAL-E
wal-e backup-push /var/lib/postgresql/15/main

# Retention policy
find /backup -name "*.sql" -mtime +30 -delete
```

#### 9.1.2 Application Backup
- **Configuration files**: Daily backup to version control
- **Application logs**: Compressed and archived monthly  
- **SSL certificates**: Secure backup before expiration
- **Monitoring data**: 90 days retention

### 9.2 Update Procedures

#### 9.2.1 Application Updates
1. **Testing**: Deploy to staging environment
2. **Validation**: Run automated test suite
3. **Backup**: Create database backup
4. **Deploy**: Blue-green deployment strategy
5. **Verify**: Post-deployment health checks
6. **Rollback**: Automated rollback if issues detected

#### 9.2.2 Database Updates
1. **Schema migration**: Flyway database migration tools
2. **Data migration**: Validated migration scripts
3. **Performance testing**: Query performance validation
4. **Rollback plan**: Database restore procedures

### 9.3 Performance Tuning

#### 9.3.1 Database Optimization
```sql
-- Query performance analysis
EXPLAIN (ANALYZE, BUFFERS) 
SELECT * FROM flight_plans 
WHERE departure_airport = 'VVNB' 
AND DATE(estimated_departure) = '2025-09-12';

-- Index maintenance
REINDEX INDEX CONCURRENTLY idx_flight_date;

-- Statistics update
ANALYZE flight_plans;
```

#### 9.3.2 Application Tuning
- **JVM parameters**: Memory allocation optimization
- **Connection pooling**: HikariCP configuration tuning
- **Cache optimization**: Redis cache hit ratio monitoring
- **Garbage collection**: G1GC tuning for low latency

### 9.4 Troubleshooting Guide

#### 9.4.1 Common Issues

**Issue: Slow Query Performance**
```
Symptoms: Response time > 5 seconds
Diagnosis: Check database query plans
Solutions: 
- Update table statistics
- Add missing indexes
- Optimize query parameters
```

**Issue: High Memory Usage**
```
Symptoms: Application OutOfMemoryError
Diagnosis: Heap dump analysis
Solutions:
- Increase JVM heap size
- Fix memory leaks
- Optimize object allocation
```

**Issue: Database Connection Errors**
```
Symptoms: Connection refused errors
Diagnosis: Check connection pool status
Solutions:
- Restart connection pool
- Increase max connections
- Check network connectivity
```

#### 9.4.2 Emergency Procedures
- **Service restart**: Automated restart scripts
- **Database failover**: Standby database activation
- **Rollback deployment**: Previous version restoration
- **Emergency contacts**: 24/7 support escalation

---

## 10. APPENDICES

### Appendix A: FIXM Message Examples

#### A.1 Complete Flight Plan Response
```xml
<?xml version="1.0" encoding="UTF-8"?>
<fx:FlightPlan xmlns:fx="http://www.fixm.aero/flight/4.2"
               xmlns:fb="http://www.fixm.aero/base/4.2">
    <fx:gufi>VN123-20250912-001</fx:gufi>
    <fx:flight>
        <fx:flightIdentification>
            <fx:aircraftIdentification>VN123</fx:aircraftIdentification>
            <fx:gufi>VN123-20250912-001</fx:gufi>
        </fx:flightIdentification>
        
        <fx:aircraft>
            <fx:aircraftType>A321</fx:aircraftType>
            <fx:registration>VN-A123</fx:registration>
            <fx:operatorDesignator>HVN</fx:operatorDesignator>
        </fx:aircraft>
        
        <fx:departure>
            <fx:aerodrome>VVNB</fx:aerodrome>
            <fx:estimatedOffBlockTime>2025-09-12T02:00:00Z</fx:estimatedOffBlockTime>
            <fx:runway>11L</fx:runway>
        </fx:departure>
        
        <fx:arrival>
            <fx:aerodrome>VVTS</fx:aerodrome>
            <fx:estimatedOnBlockTime>2025-09-12T04:30:00Z</fx:estimatedOnBlockTime>
        </fx:arrival>
        
        <fx:routeTrajectory>
            <fx:routeInformation>
                <fx:routeText>VVNB DCT ADMOX A1 OTBAN VVTS</fx:routeText>
                <fx:totalEstimatedElapsedTime>PT2H30M</fx:totalEstimatedElapsedTime>
            </fx:routeInformation>
            
            <fx:trajectory4D>
                <fx:element seqNum="1">
                    <fx:elementStartPoint>
                        <fx:position>
                            <fb:latitude>21.221192</fb:latitude>
                            <fb:longitude>105.807178</fb:longitude>
                        </fx:position>
                        <fx:altitude>
                            <fb:altitude>0</fb:altitude>
                            <fb:altitudeReference>MSL</fb:altitudeReference>
                        </fx:altitude>
                        <fx:time>2025-09-12T02:00:00Z</fx:time>
                    </fx:elementStartPoint>
                </fx:element>
            </fx:trajectory4D>
        </fx:routeTrajectory>
        
        <fx:flightStatus>FILED</fx:flightStatus>
        <fx:specialHandling>NIL</fx:specialHandling>
        
    </fx:flight>
</fx:FlightPlan>
```

### Appendix B: Database Schema Scripts

#### B.1 Full Database Schema
```sql
-- Create database
CREATE DATABASE vatm_query_service 
    WITH ENCODING 'UTF8' 
    LC_COLLATE = 'en_US.UTF-8' 
    LC_CTYPE = 'en_US.UTF-8';

-- Create application user
CREATE USER query_service_app WITH PASSWORD 'secure_password_2025';
GRANT CONNECT ON DATABASE vatm_query_service TO query_service_app;
GRANT USAGE ON SCHEMA public TO query_service_app;

-- flight_plans table with full specifications
CREATE TABLE flight_plans (
    id                      BIGSERIAL PRIMARY KEY,
    gufi                   VARCHAR(50) UNIQUE NOT NULL,
    flight_number          VARCHAR(10) NOT NULL,
    aircraft_registration  VARCHAR(10),
    aircraft_type          VARCHAR(10),
    operator_code          VARCHAR(3),
    departure_airport      VARCHAR(4) NOT NULL,
    arrival_airport        VARCHAR(4) NOT NULL,
    estimated_departure    TIMESTAMP WITH TIME ZONE,
    estimated_arrival      TIMESTAMP WITH TIME ZONE,
    actual_departure       TIMESTAMP WITH TIME ZONE,
    actual_arrival         TIMESTAMP WITH TIME ZONE,
    scheduled_departure    TIMESTAMP WITH TIME ZONE,
    scheduled_arrival      TIMESTAMP WITH TIME ZONE,
    route_text            TEXT,
    cruise_altitude       INTEGER,
    cruise_speed          INTEGER,
    flight_rules          VARCHAR(1) DEFAULT 'I', -- I=IFR, V=VFR
    flight_type           VARCHAR(1) DEFAULT 'S', -- S=Scheduled, N=Non-scheduled
    flight_status         VARCHAR(20) DEFAULT 'FILED',
    airline_code          VARCHAR(3),
    equipment_code        VARCHAR(20),
    wake_turbulence       VARCHAR(1), -- L=Light, M=Medium, H=Heavy, J=Super
    souls_on_board        INTEGER,
    fuel_endurance_hours  INTEGER,
    fuel_endurance_minutes INTEGER,
    alternate_airports    VARCHAR(50),
    remarks              TEXT,
    fixm_data            JSONB, -- Complete FIXM XML stored as JSON
    trajectory_data      JSONB, -- 4D trajectory points
    weather_data         JSONB, -- Weather conditions
    created_at           TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at           TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by           VARCHAR(50),
    updated_by           VARCHAR(50),
    
    -- Constraints
    CONSTRAINT chk_flight_rules CHECK (flight_rules IN ('I', 'V')),
    CONSTRAINT chk_flight_type CHECK (flight_type IN ('S', 'N', 'G', 'M')),
    CONSTRAINT chk_wake_turbulence CHECK (wake_turbulence IN ('L', 'M', 'H', 'J')),
    CONSTRAINT chk_valid_airports CHECK (LENGTH(departure_airport) = 4 AND LENGTH(arrival_airport) = 4),
    CONSTRAINT chk_departure_before_arrival CHECK (estimated_departure < estimated_arrival)
);

-- Indexes for performance
CREATE INDEX idx_flight_plans_gufi ON flight_plans (gufi);
CREATE INDEX idx_flight_plans_flight_date ON flight_plans (flight_number, DATE(estimated_departure));
CREATE INDEX idx_flight_plans_route ON flight_plans (departure_airport, arrival_airport);
CREATE INDEX idx_flight_plans_aircraft ON flight_plans (aircraft_registration);
CREATE INDEX idx_flight_plans_airline_date ON flight_plans (airline_code, DATE(estimated_departure));
CREATE INDEX idx_flight_plans_status ON flight_plans (flight_status);
CREATE INDEX idx_flight_plans_created ON flight_plans (created_at DESC);
CREATE INDEX idx_flight_plans_departure_time ON flight_plans (estimated_departure);
CREATE INDEX idx_flight_plans_operator ON flight_plans (operator_code);

-- Partial indexes for active flights
CREATE INDEX idx_flight_plans_active_status ON flight_plans (flight_status) 
    WHERE flight_status IN ('FILED', 'ACTIVE', 'AIRBORNE');

-- GIN index for JSONB data
CREATE INDEX idx_flight_plans_fixm_data ON flight_plans USING GIN (fixm_data);
CREATE INDEX idx_flight_plans_trajectory ON flight_plans USING GIN (trajectory_data);

-- aircraft_types table
CREATE TABLE aircraft_types (
    code               VARCHAR(10) PRIMARY KEY,
    manufacturer       VARCHAR(50) NOT NULL,
    model             VARCHAR(50) NOT NULL,
    variant           VARCHAR(50),
    category          VARCHAR(20) NOT NULL, -- 'narrow-body', 'wide-body', 'regional', 'cargo'
    engine_type       VARCHAR(20) NOT NULL, -- 'jet', 'turboprop', 'piston'
    engine_count      INTEGER,
    max_passengers    INTEGER,
    max_cargo_kg      INTEGER,
    mtow_kg           INTEGER, -- Maximum Take-Off Weight
    cruise_speed_kts  INTEGER,
    service_ceiling_ft INTEGER,
    range_nm          INTEGER,
    wake_category     VARCHAR(1), -- L, M, H, J
    noise_category    VARCHAR(10),
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- airports table
CREATE TABLE airports (
    icao_code         VARCHAR(4) PRIMARY KEY,
    iata_code         VARCHAR(3) UNIQUE,
    name              VARCHAR(200) NOT NULL,
    city              VARCHAR(100),
    country_code      VARCHAR(3) NOT NULL,
    region            VARCHAR(50),
    latitude          DECIMAL(10,6),
    longitude         DECIMAL(11,6),
    elevation_ft      INTEGER,
    magnetic_variation DECIMAL(5,2),
    timezone          VARCHAR(50),
    airport_type      VARCHAR(20), -- 'international', 'domestic', 'regional', 'military'
    runway_count      INTEGER,
    longest_runway_ft INTEGER,
    customs_available BOOLEAN DEFAULT FALSE,
    fuel_available    BOOLEAN DEFAULT TRUE,
    tower_frequency   VARCHAR(20),
    ground_frequency  VARCHAR(20),
    approach_frequency VARCHAR(20),
    active            BOOLEAN DEFAULT TRUE,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- airlines table
CREATE TABLE airlines (
    iata_code         VARCHAR(3) PRIMARY KEY,
    icao_code         VARCHAR(3) UNIQUE NOT NULL,
    name              VARCHAR(200) NOT NULL,
    country_code      VARCHAR(3) NOT NULL,
    alliance          VARCHAR(50),
    fleet_size        INTEGER,
    destinations      INTEGER,
    founded_year      INTEGER,
    headquarters      VARCHAR(100),
    website           VARCHAR(200),
    active            BOOLEAN DEFAULT TRUE,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- waypoints table for route information
CREATE TABLE waypoints (
    id                BIGSERIAL PRIMARY KEY,
    identifier        VARCHAR(10) NOT NULL,
    name              VARCHAR(100),
    type              VARCHAR(20) NOT NULL, -- 'VOR', 'NDB', 'FIX', 'AIRPORT'
    country_code      VARCHAR(3),
    region            VARCHAR(10),
    latitude          DECIMAL(10,6) NOT NULL,
    longitude         DECIMAL(11,6) NOT NULL,
    frequency         VARCHAR(10),
    magnetic_variation DECIMAL(5,2),
    usage             VARCHAR(20), -- 'ENROUTE', 'TERMINAL', 'APPROACH'
    active            BOOLEAN DEFAULT TRUE,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    UNIQUE(identifier, region)
);

-- airways table for route structure
CREATE TABLE airways (
    id                BIGSERIAL PRIMARY KEY,
    designator        VARCHAR(10) NOT NULL,
    type              VARCHAR(10) NOT NULL, -- 'HIGH', 'LOW', 'RNAV'
    direction         VARCHAR(10), -- 'FORWARD', 'BACKWARD', 'BOTH'
    minimum_altitude  INTEGER,
    maximum_altitude  INTEGER,
    magnetic_course   INTEGER,
    distance_nm       DECIMAL(6,2),
    from_waypoint     VARCHAR(10) NOT NULL,
    to_waypoint       VARCHAR(10) NOT NULL,
    country_code      VARCHAR(3),
    active            BOOLEAN DEFAULT TRUE,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    INDEX idx_airways_designator (designator),
    INDEX idx_airways_waypoints (from_waypoint, to_waypoint)
);

-- flight_events table for tracking flight lifecycle
CREATE TABLE flight_events (
    id                BIGSERIAL PRIMARY KEY,
    flight_plan_id    BIGINT NOT NULL REFERENCES flight_plans(id) ON DELETE CASCADE,
    event_type        VARCHAR(50) NOT NULL, -- 'FILED', 'APPROVED', 'ACTIVATED', 'DEPARTED', 'ARRIVED', 'CANCELLED'
    event_time        TIMESTAMP WITH TIME ZONE NOT NULL,
    event_details     JSONB,
    source_system     VARCHAR(50),
    created_by        VARCHAR(50),
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    INDEX idx_flight_events_flight_id (flight_plan_id),
    INDEX idx_flight_events_type (event_type),
    INDEX idx_flight_events_time (event_time DESC)
);

-- api_keys table for authentication
CREATE TABLE api_keys (
    id                BIGSERIAL PRIMARY KEY,
    key_value         VARCHAR(100) UNIQUE NOT NULL,
    organization      VARCHAR(100) NOT NULL,
    contact_email     VARCHAR(200),
    access_level      VARCHAR(20) DEFAULT 'READ-only', -- 'read-only', 'full-access', 'admin'
    rate_limit_hour   INTEGER DEFAULT 1000,
    rate_limit_minute INTEGER DEFAULT 50,
    allowed_ips       TEXT[], -- Array of allowed IP addresses
    expires_at        TIMESTAMP WITH TIME ZONE,
    active            BOOLEAN DEFAULT TRUE,
    last_used_at      TIMESTAMP WITH TIME ZONE,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_by        VARCHAR(50),
    
    INDEX idx_api_keys_key (key_value),
    INDEX idx_api_keys_org (organization),
    INDEX idx_api_keys_active (active, expires_at)
);

-- api_usage_logs table for monitoring
CREATE TABLE api_usage_logs (
    id                BIGSERIAL PRIMARY KEY,
    api_key_id        BIGINT REFERENCES api_keys(id),
    endpoint          VARCHAR(200) NOT NULL,
    method            VARCHAR(10) NOT NULL,
    request_params    JSONB,
    response_status   INTEGER NOT NULL,
    response_time_ms  INTEGER,
    client_ip         INET,
    user_agent        TEXT,
    request_time      TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    
    INDEX idx_api_logs_key_time (api_key_id, request_time DESC),
    INDEX idx_api_logs_endpoint (endpoint),
    INDEX idx_api_logs_status (response_status),
    INDEX idx_api_logs_time (request_time DESC)
);

-- system_config table for application settings
CREATE TABLE system_config (
    id                BIGSERIAL PRIMARY KEY,
    config_key        VARCHAR(100) UNIQUE NOT NULL,
    config_value      TEXT NOT NULL,
    description       TEXT,
    data_type         VARCHAR(20) DEFAULT 'string', -- 'string', 'integer', 'boolean', 'json'
    category          VARCHAR(50),
    editable          BOOLEAN DEFAULT TRUE,
    created_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at        TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_by        VARCHAR(50)
);

-- Grant permissions to application user
GRANT SELECT, INSERT, UPDATE ON ALL TABLES IN SCHEMA public TO query_service_app;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO query_service_app;
```

#### B.2 Sample Data Insert Scripts
```sql
-- Insert Vietnamese airports
INSERT INTO airports (icao_code, iata_code, name, city, country_code, latitude, longitude, elevation_ft, timezone, airport_type) VALUES
('VVNB', 'HAN', 'Noi Bai International Airport', 'Hanoi', 'VNM', 21.221192, 105.807178, 39, 'Asia/Ho_Chi_Minh', 'international'),
('VVTS', 'SGN', 'Tan Son Nhat International Airport', 'Ho Chi Minh City', 'VNM', 10.818797, 106.651856, 33, 'Asia/Ho_Chi_Minh', 'international'),
('VVDN', 'DAD', 'Da Nang International Airport', 'Da Nang', 'VNM', 16.043917, 108.199500, 33, 'Asia/Ho_Chi_Minh', 'international'),
('VVCI', 'CXR', 'Cam Ranh International Airport', 'Nha Trang', 'VNM', 11.998153, 109.219211, 23, 'Asia/Ho_Chi_Minh', 'international'),
('VVPQ', 'PQC', 'Phu Quoc International Airport', 'Phu Quoc', 'VNM', 10.227025, 103.967169, 33, 'Asia/Ho_Chi_Minh', 'international');

-- Insert Vietnamese airlines
INSERT INTO airlines (iata_code, icao_code, name, country_code, fleet_size, destinations) VALUES
('VN', 'HVN', 'Vietnam Airlines', 'VNM', 95, 64),
('VJ', 'VJC', 'Vietjet Air', 'VNM', 85, 45),
('QH', 'BBV', 'Bamboo Airways', 'VNM', 30, 25),
('VU', 'VKG', 'Vietravel Airlines', 'VNM', 15, 18);

-- Insert common aircraft types
INSERT INTO aircraft_types (code, manufacturer, model, category, engine_type, max_passengers, mtow_kg, cruise_speed_kts, wake_category) VALUES
('A321', 'Airbus', 'A321', 'narrow-body', 'jet', 220, 93500, 450, 'M'),
('A320', 'Airbus', 'A320', 'narrow-body', 'jet', 180, 78000, 450, 'M'),
('B737', 'Boeing', '737-800', 'narrow-body', 'jet', 189, 79016, 450, 'M'),
('A350', 'Airbus', 'A350-900', 'wide-body', 'jet', 315, 280000, 490, 'H'),
('B787', 'Boeing', '787-9', 'wide-body', 'jet', 290, 254011, 490, 'H');

-- Insert sample waypoints
INSERT INTO waypoints (identifier, name, type, country_code, latitude, longitude) VALUES
('ADMOX', 'ADMOX Waypoint', 'FIX', 'VNM', 18.5667, 106.5833),
('OTBAN', 'OTBAN Waypoint', 'FIX', 'VNM', 13.2333, 106.8333),
('BOBAG', 'BOBAG Waypoint', 'FIX', 'VNM', 15.8333, 107.5000),
('XAMBO', 'XAMBO Waypoint', 'FIX', 'VNM', 19.1667, 105.9167);

-- Insert API keys for testing
INSERT INTO api_keys (key_value, organization, access_level, contact_email) VALUES
('vatm_test_key_2025_001', 'VATM Internal Testing', 'admin', 'tech@vatm.vn'),
('vn_airlines_key_001', 'Vietnam Airlines', 'read-only', 'it@vietnamairlines.com'),
('vietjet_api_key_001', 'Vietjet Air', 'read-only', 'tech@vietjetair.com');

-- Insert system configuration
INSERT INTO system_config (config_key, config_value, description, category) VALUES
('max_query_results', '100', 'Maximum number of results per query', 'performance'),
('cache_ttl_seconds', '300', 'Cache time-to-live in seconds', 'performance'),
('rate_limit_enabled', 'true', 'Enable API rate limiting', 'security'),
('log_retention_days', '90', 'API usage log retention period', 'logging');

-- Insert sample flight plans
INSERT INTO flight_plans (
    gufi, flight_number, aircraft_registration, aircraft_type, operator_code,
    departure_airport, arrival_airport, estimated_departure, estimated_arrival,
    route_text, cruise_altitude, cruise_speed, airline_code, flight_status
) VALUES
('VN123-20250912-001', 'VN123', 'VN-A123', 'A321', 'HVN', 'VVNB', 'VVTS', 
 '2025-09-12 02:00:00+00', '2025-09-12 04:30:00+00', 
 'VVNB DCT ADMOX A1 OTBAN VVTS', 37000, 450, 'VN', 'FILED'),

('VJ456-20250912-001', 'VJ456', 'VN-A456', 'A320', 'VJC', 'VVTS', 'VVDN',
 '2025-09-12 03:15:00+00', '2025-09-12 04:45:00+00',
 'VVTS DCT BOBAG B1 VVDN', 35000, 440, 'VJ', 'FILED'),

('QH789-20250912-001', 'QH789', 'VN-A789', 'B737', 'BBV', 'VVDN', 'VVNB',
 '2025-09-12 06:30:00+00', '2025-09-12 08:15:00+00',
 'VVDN DCT XAMBO A1 VVNB', 36000, 445, 'QH', 'FILED');
```

### Appendix C: Configuration Files

#### C.1 Application Configuration (application.yml)
```yaml
# Spring Boot Configuration
spring:
  application:
    name: vatm-query-service
  profiles:
    active: production
    
  # Database Configuration
  datasource:
    url: jdbc:postgresql://10.1.1.20:5432/vatm_query_service
    username: query_service_app
    password: ${DB_PASSWORD:secure_password_2025}
    hikari:
      maximum-pool-size: 50
      minimum-idle: 10
      idle-timeout: 300000
      connection-timeout: 30000
      max-lifetime: 1800000
      
  # JPA Configuration  
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        format_sql: false
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          batch_size: 20
        cache:
          use_second_level_cache: true
          use_query_cache: true
          
  # Redis Configuration
  redis:
    host: 10.1.1.20
    port: 6379
    password: ${REDIS_PASSWORD:redis_secure_2025}
    timeout: 2000ms
    jedis:
      pool:
        max-active: 50
        max-idle: 10
        min-idle: 5
        
  # Jackson Configuration
  jackson:
    serialization:
      write-dates-as-timestamps: false
    time-zone: Asia/Ho_Chi_Minh
    date-format: "yyyy-MM-dd'T'HH:mm:ss.SSSXXX"

# Server Configuration
server:
  port: 8080
  servlet:
    context-path: /api/v1
  compression:
    enabled: true
    mime-types: application/json,application/xml,text/html,text/xml,text/plain
  forward-headers-strategy: native

# Management Endpoints
management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus,info
      base-path: /actuator
  endpoint:
    health:
      show-details: when-authorized
    metrics:
      enabled: true
  metrics:
    export:
      prometheus:
        enabled: true
        
# Application Specific Configuration
vatm:
  query-service:
    # Performance Settings
    max-results-per-query: 100
    default-page-size: 20
    query-timeout-seconds: 30
    
    # Cache Settings
    cache:
      enabled: true
      ttl-seconds: 300
      max-size: 10000
      
    # Rate Limiting
    rate-limit:
      enabled: true
      default-hourly-limit: 1000
      default-minute-limit: 50
      
    # FIXM Settings
    fixm:
      version: "4.2.0"
      validate-output: true
      pretty-print: false
      
    # Security Settings
    security:
      api-key-header: "X-API-Key"
      cors-enabled: true
      allowed-origins: 
        - "https://portal.vatm.vn"
        - "https://swim.vatm.vn"
        
    # Integration Settings
    integration:
      swim:
        enabled: true
        endpoint: "https://swim.vatm.vn"
        timeout-seconds: 10

# Logging Configuration
logging:
  level:
    com.vatm.queryservice: INFO
    org.springframework.web: WARN
    org.hibernate.SQL: WARN
    org.hibernate.type.descriptor.sql.BasicBinder: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"
  file:
    name: /var/log/vatm/query-service.log
    max-size: 100MB
    max-history: 30

---
# Development Profile
spring:
  config:
    activate:
      on-profile: development
  datasource:
    url: jdbc:postgresql://localhost:5432/vatm_query_service_dev
    username: postgres
    password: postgres
  jpa:
    hibernate:
      ddl-auto: update
    show-sql: true
    
vatm:
  query-service:
    cache:
      enabled: false
    rate-limit:
      enabled: false

logging:
  level:
    com.vatm.queryservice: DEBUG
    org.springframework.web: DEBUG
```

#### C.2 Docker Configuration (Dockerfile)
```dockerfile
# Multi-stage build
FROM openjdk:17-jdk-slim AS builder

# Set working directory
WORKDIR /app

# Copy maven files
COPY pom.xml .
COPY src ./src

# Install Maven
RUN apt-get update && apt-get install -y maven

# Build application
RUN mvn clean package -DskipTests

# Production image
FROM openjdk:17-jre-slim

# Install required packages
RUN apt-get update && \
    apt-get install -y curl netcat-openbsd && \
    rm -rf /var/lib/apt/lists/*

# Create application user
RUN groupadd -r vatm && useradd -r -g vatm vatm

# Set working directory
WORKDIR /app

# Copy application jar
COPY --from=builder /app/target/vatm-query-service-*.jar app.jar

# Copy configuration files
COPY docker/application.yml ./
COPY docker/startup.sh ./
RUN chmod +x startup.sh

# Create directories
RUN mkdir -p /var/log/vatm && \
    chown -R vatm:vatm /app /var/log/vatm

# Switch to application user
USER vatm

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8080/actuator/health || exit 1

# Expose port
EXPOSE 8080

# Entry point
ENTRYPOINT ["./startup.sh"]
```

#### C.3 Docker Compose (docker-compose.yml)
```yaml
version: '3.8'

services:
  # Application Service
  query-service:
    build: .
    image: vatm/query-service:latest
    container_name: vatm-query-service
    restart: unless-stopped
    environment:
      - SPRING_PROFILES_ACTIVE=production
      - DB_PASSWORD=${DB_PASSWORD}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - JVM_OPTS=-Xms2g -Xmx4g -XX:+UseG1GC
    ports:
      - "8080:8080"
    volumes:
      - ./logs:/var/log/vatm
      - ./config:/app/config
    depends_on:
      - postgres
      - redis
    networks:
      - vatm-network
      
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: vatm-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_DB=vatm_query_service
      - POSTGRES_USER=query_service_app
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
      - ./backups:/backups
    ports:
      - "5432:5432"
    networks:
      - vatm-network
      
  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: vatm-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - vatm-network
      
  # Nginx Load Balancer
  nginx:
    image: nginx:alpine
    container_name: vatm-nginx
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - query-service
    networks:
      - vatm-network
      
  # Prometheus Monitoring
  prometheus:
    image: prom/prometheus:latest
    container_name: vatm-prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    networks:
      - vatm-network

volumes:
  postgres_data:
  redis_data:
  prometheus_data:

networks:
  vatm-network:
    driver: bridge
```

### Appendix D: API Testing Scripts

#### D.1 Postman Collection
```json
{
  "info": {
    "name": "VATM Query Service API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "auth": {
    "type": "apikey",
    "apikey": [
      {"key": "key", "value": "X-API-Key"},
      {"key": "value", "value": "{{api_key}}"}
    ]
  },
  "variable": [
    {"key": "base_url", "value": "https://query.vatm.vn/api/v1"},
    {"key": "api_key", "value": "vatm_test_key_2025_001"}
  ],
  "item": [
    {
      "name": "Get Flight by GUFI",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/query/flight/VN123-20250912-001",
          "host": ["{{base_url}}"],
          "path": ["query", "flight", "VN123-20250912-001"]
        }
      },
      "response": []
    },
    {
      "name": "Search Flights by Route",
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{base_url}}/query/search?departureAirport=VVNB&arrivalAirport=VVTS&date=2025-09-12",
          "host": ["{{base_url}}"],
          "path": ["query", "search"],
          "query": [
            {"key": "departureAirport", "value": "VVNB"},
            {"key": "arrivalAirport", "value": "VVTS"},
            {"key": "date", "value": "2025-09-12"}
          ]
        }
      },
      "response": []
    },
    {
      "name": "Bulk Query",
      "request": {
        "method": "POST",
        "header": [
          {"key": "Content-Type", "value": "application/json"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"queries\": [\n    {\"gufi\": \"VN123-20250912-001\"},\n    {\"flightNumber\": \"VJ456\", \"date\": \"2025-09-12\"},\n    {\"route\": {\"departure\": \"VVDN\", \"arrival\": \"VVNB\"}}\n  ],\n  \"format\": \"summary\"\n}"
        },
        "url": {
          "raw": "{{base_url}}/query/bulk",
          "host": ["{{base_url}}"],
          "path": ["query", "bulk"]
        }
      },
      "response": []
    }
  ]
}
```

#### D.2 Performance Testing Script (JMeter)
```xml
<?xml version="1.0" encoding="UTF-8"?>
<jmeterTestPlan version="1.2" properties="5.0" jmeter="5.4.1">
  <hashTree>
    <TestPlan guiclass="TestPlanGui" testclass="TestPlan" testname="VATM Query Service Load Test">
      <stringProp name="TestPlan.comments">Load test for VATM Query Service</stringProp>
      <boolProp name="TestPlan.functional_mode">false</boolProp>
      <boolProp name="TestPlan.tearDown_on_shutdown">true</boolProp>
      <boolProp name="TestPlan.serialize_threadgroups">false</boolProp>
      <elementProp name="TestPlan.arguments" elementType="Arguments" guiclass="ArgumentsPanel" testclass="Arguments" testname="User Defined Variables">
        <collectionProp name="Arguments.arguments">
          <elementProp name="base_url" elementType="Argument">
            <stringProp name="Argument.name">base_url</stringProp>
            <stringProp name="Argument.value">https://query.vatm.vn/api/v1</stringProp>
          </elementProp>
          <elementProp name="api_key" elementType="Argument">
            <stringProp name="Argument.name">api_key</stringProp>
            <stringProp name="Argument.value">vatm_test_key_2025_001</stringProp>
          </elementProp>
        </collectionProp>
      </elementProp>
    </TestPlan>
    
    <hashTree>
      <!-- Thread Group for Load Testing -->
      <ThreadGroup guiclass="ThreadGroupGui" testclass="ThreadGroup" testname="Query Service Load">
        <stringProp name="ThreadGroup.on_sample_error">continue</stringProp>
        <elementProp name="ThreadGroup.main_controller" elementType="LoopController" guiclass="LoopControlGui" testclass="LoopController" testname="Loop Controller">
          <boolProp name="LoopController.continue_forever">false</boolProp>
          <stringProp name="LoopController.loops">10</stringProp>
        </elementProp>
        <stringProp name="ThreadGroup.num_threads">50</stringProp>
        <stringProp name="ThreadGroup.ramp_time">60</stringProp>
        <boolProp name="ThreadGroup.scheduler">true</boolProp>
        <stringProp name="ThreadGroup.duration">300</stringProp>
        <stringProp name="ThreadGroup.delay">0</stringProp>
      </ThreadGroup>
      
      <hashTree>
        <!-- HTTP Request Defaults -->
        <ConfigTestElement guiclass="HttpDefaultsGui" testclass="ConfigTestElement" testname="HTTP Request Defaults">
          <elementProp name="HTTPsampler.Arguments" elementType="Arguments" guiclass="ArgumentsPanel" testclass="Arguments" testname="User Defined Variables">
            <collectionProp name="Arguments.arguments"/>
          </elementProp>
          <stringProp name="HTTPSampler.domain"></stringProp>
          <stringProp name="HTTPSampler.port"></stringProp>
          <stringProp name="HTTPSampler.protocol">https</stringProp>
          <stringProp name="HTTPSampler.contentEncoding"></stringProp>
          <stringProp name="HTTPSampler.path">${base_url}</stringProp>
        </ConfigTestElement>
        
        <!-- Header Manager -->
        <HeaderManager guiclass="HeaderPanel" testclass="HeaderManager" testname="HTTP Header Manager">
          <collectionProp name="HeaderManager.headers">
            <elementProp name="" elementType="Header">
              <stringProp name="Header.name">X-API-Key</stringProp>
              <stringProp name="Header.value">${api_key}</stringProp>
            </elementProp>
            <elementProp name="" elementType="Header">
              <stringProp name="Header.name">Accept</stringProp>
              <stringProp name="Header.value">application/json</stringProp>
            </elementProp>
          </collectionProp>
        </HeaderManager>
        
        <!-- Test Scenarios -->
        <RandomController guiclass="RandomControlGui" testclass="RandomController" testname="Random Test Scenarios">
          <intProp name="InterleaveControl.style">1</intProp>
        </RandomController>
        
        <hashTree>
          <!-- Scenario 1: GUFI Query -->
          <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy" testname="Query by GUFI">
            <elementProp name="HTTPsampler.Arguments" elementType="Arguments" guiclass="ArgumentsPanel" testclass="Arguments" testname="User Defined Variables">
              <collectionProp name="Arguments.arguments"/>
            </elementProp>
            <stringProp name="HTTPSampler.domain"></stringProp>
            <stringProp name="HTTPSampler.port"></stringProp>
            <stringProp name="HTTPSampler.protocol"></stringProp>
            <stringProp name="HTTPSampler.contentEncoding"></stringProp>
            <stringProp name="HTTPSampler.path">/query/flight/VN123-20250912-001</stringProp>
            <stringProp name="HTTPSampler.method">GET</stringProp>
            <boolProp name="HTTPSampler.follow_redirects">true</boolProp>
            <boolProp name="HTTPSampler.auto_redirects">false</boolProp>
            <boolProp name="HTTPSampler.use_keepalive">true</boolProp>
          </HTTPSamplerProxy>
          
          <!-- Scenario 2: Flight Search -->
          <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy" testname="Search by Route">
            <elementProp name="HTTPsampler.Arguments" elementType="Arguments" guiclass="ArgumentsPanel" testclass="Arguments" testname="User Defined Variables">
              <collectionProp name="Arguments.arguments">
                <elementProp name="departureAirport" elementType="HTTPArgument">
                  <boolProp name="HTTPArgument.always_encode">false</boolProp>
                  <stringProp name="Argument.value">VVNB</stringProp>
                  <stringProp name="Argument.name">departureAirport</stringProp>
                </elementProp>
                <elementProp name="arrivalAirport" elementType="HTTPArgument">
                  <boolProp name="HTTPArgument.always_encode">false</boolProp>
                  <stringProp name="Argument.value">VVTS</stringProp>
                  <stringProp name="Argument.name">arrivalAirport</stringProp>
                </elementProp>
                <elementProp name="date" elementType="HTTPArgument">
                  <boolProp name="HTTPArgument.always_encode">false</boolProp>
                  <stringProp name="Argument.value">2025-09-12</stringProp>
                  <stringProp name="Argument.name">date</stringProp>
                </elementProp>
              </collectionProp>
            </elementProp>
            <stringProp name="HTTPSampler.path">/query/search</stringProp>
            <stringProp name="HTTPSampler.method">GET</stringProp>
          </HTTPSamplerProxy>
          
          <!-- Scenario 3: Flight Number Search -->
          <HTTPSamplerProxy guiclass="HttpTestSampleGui" testclass="HTTPSamplerProxy" testname="Search by Flight Number">
            <elementProp name="HTTPsampler.Arguments" elementType="Arguments" guiclass="ArgumentsPanel" testclass="Arguments" testname="User Defined Variables">
              <collectionProp name="Arguments.arguments">
                <elementProp name="flightNumber" elementType="HTTPArgument">
                  <boolProp name="HTTPArgument.always_encode">false</boolProp>
                  <stringProp name="Argument.value">VN${__Random(100,999)}</stringProp>
                  <stringProp name="Argument.name">flightNumber</stringProp>
                </elementProp>
                <elementProp name="date" elementType="HTTPArgument">
                  <boolProp name="HTTPArgument.always_encode">false</boolProp>
                  <stringProp name="Argument.value">2025-09-12</stringProp>
                  <stringProp name="Argument.name">date</stringProp>
                </elementProp>
              </collectionProp>
            </elementProp>
            <stringProp name="HTTPSampler.path">/query/search</stringProp>
            <stringProp name="HTTPSampler.method">GET</stringProp>
          </HTTPSamplerProxy>
        </hashTree>
        
        <!-- Response Assertions -->
        <ResponseAssertion guiclass="AssertionGui" testclass="ResponseAssertion" testname="Response Code Assertion">
          <collectionProp name="Asserion.test_strings">
            <stringProp name="49586">200</stringProp>
          </collectionProp>
          <stringProp name="Assertion.custom_message"></stringProp>
          <stringProp name="Assertion.test_field">Assertion.response_code</stringProp>
          <boolProp name="Assertion.assume_success">false</boolProp>
          <intProp name="Assertion.test_type">1</intProp>
        </ResponseAssertion>
        
        <ResponseAssertion guiclass="AssertionGui" testclass="ResponseAssertion" testname="Response Time Assertion">
          <collectionProp name="Asserion.test_strings">
            <stringProp name="1629">2000</stringProp>
          </collectionProp>
          <stringProp name="Assertion.test_field">Assertion.response_time</stringProp>
          <intProp name="Assertion.test_type">6</intProp>
        </ResponseAssertion>
        
        <!-- Listeners -->
        <ResultCollector guiclass="ViewResultsFullVisualizer" testclass="ResultCollector" testname="View Results Tree">
          <boolProp name="ResultCollector.error_logging">false</boolProp>
          <objProp>
            <name>saveConfig</name>
            <value class="SampleSaveConfiguration">
              <time>true</time>
              <latency>true</latency>
              <timestamp>true</timestamp>
              <success>true</success>
              <label>true</label>
              <code>true</code>
              <message>true</message>
              <threadName>true</threadName>
              <dataType>true</dataType>
              <encoding>false</encoding>
              <assertions>true</assertions>
              <subresults>true</subresults>
              <responseData>false</responseData>
              <samplerData>false</samplerData>
              <xml>false</xml>
              <fieldNames>true</fieldNames>
              <responseHeaders>false</responseHeaders>
              <requestHeaders>false</requestHeaders>
              <responseDataOnError>false</responseDataOnError>
              <saveAssertionResultsFailureMessage>true</saveAssertionResultsFailureMessage>
              <assertionsResultsToSave>0</assertionsResultsToSave>
              <bytes>true</bytes>
              <sentBytes>true</sentBytes>
              <url>true</url>
              <threadCounts>true</threadCounts>
              <idleTime>true</idleTime>
              <connectTime>true</connectTime>
            </value>
          </objProp>
          <stringProp name="filename">test_results.jtl</stringProp>
        </ResultCollector>
        
        <ResultCollector guiclass="SummaryReport" testclass="ResultCollector" testname="Summary Report">
          <boolProp name="ResultCollector.error_logging">false</boolProp>
          <objProp>
            <name>saveConfig</name>
            <value class="SampleSaveConfiguration">
              <time>true</time>
              <latency>true</latency>
              <timestamp>true</timestamp>
              <success>true</success>
              <label>true</label>
              <code>true</code>
              <message>true</message>
              <threadName>true</threadName>
              <dataType>true</dataType>
              <encoding>false</encoding>
              <assertions>true</assertions>
              <subresults>true</subresults>
              <responseData>false</responseData>
              <samplerData>false</samplerData>
              <xml>false</xml>
              <fieldNames>true</fieldNames>
              <responseHeaders>false</responseHeaders>
              <requestHeaders>false</requestHeaders>
              <responseDataOnError>false</responseDataOnError>
              <saveAssertionResultsFailureMessage>true</saveAssertionResultsFailureMessage>
              <assertionsResultsToSave>0</assertionsResultsToSave>
              <bytes>true</bytes>
              <sentBytes>true</sentBytes>
              <url>true</url>
              <threadCounts>true</threadCounts>
              <idleTime>true</idleTime>
              <connectTime>true</connectTime>
            </value>
          </objProp>
          <stringProp name="filename">summary_report.jtl</stringProp>
        </ResultCollector>
      </hashTree>
    </hashTree>
  </hashTree>
</jmeterTestPlan>
```

### Appendix E: Deployment Scripts

#### E.1 Deployment Script (deploy.sh)
```bash
#!/bin/bash

# VATM Query Service Deployment Script
# Version: 1.0
# Usage: ./deploy.sh [environment] [version]

set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_NAME="vatm-query-service"
DOCKER_REGISTRY="registry.vatm.vn"
ENVIRONMENTS=("development" "staging" "production")

# Default values
ENVIRONMENT="${1:-staging}"
VERSION="${2:-latest}"
BACKUP_ENABLED="${BACKUP_ENABLED:-true}"
ROLLBACK_ENABLED="${ROLLBACK_ENABLED:-true}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Logging functions
log_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# Validation functions
validate_environment() {
    if [[ ! " ${ENVIRONMENTS[@]} " =~ " ${ENVIRONMENT} " ]]; then
        log_error "Invalid environment: ${ENVIRONMENT}"
        log_info "Valid environments: ${ENVIRONMENTS[*]}"
        exit 1
    fi
}

validate_version() {
    if [[ ! "${VERSION}" =~ ^[0-9]+\.[0-9]+\.[0-9]+$|^latest$ ]]; then
        log_error "Invalid version format: ${VERSION}"
        log_info "Version should be in format: x.y.z or 'latest'"
        exit 1
    fi
}

check_prerequisites() {
    local prerequisites=("docker" "docker-compose" "kubectl")
    
    for cmd in "${prerequisites[@]}"; do
        if ! command -v "$cmd" &> /dev/null; then
            log_error "$cmd is required but not installed"
            exit 1
        fi
    done
    
    log_success "Prerequisites check passed"
}

# Backup functions
backup_database() {
    if [[ "${BACKUP_ENABLED}" == "true" ]]; then
        log_info "Creating database backup..."
        
        local backup_file="backup_${ENVIRONMENT}_$(date +%Y%m%d_%H%M%S).sql"
        local backup_path="/backups/${backup_file}"
        
        docker exec vatm-postgres pg_dump -U query_service_app -d vatm_query_service > "${backup_path}"
        
        if [[ $? -eq 0 ]]; then
            log_success "Database backup created: ${backup_path}"
            echo "${backup_file}" > /tmp/last_backup_file
        else
            log_error "Database backup failed"
            exit 1
        fi
    else
        log_warning "Database backup is disabled"
    fi
}

backup_configuration() {
    log_info "Backing up configuration files..."
    
    local config_backup_dir="/backups/config_$(date +%Y%m%d_%H%M%S)"
    mkdir -p "${config_backup_dir}"
    
    cp -r ./config/* "${config_backup_dir}/"
    cp docker-compose.yml "${config_backup_dir}/"
    
    log_success "Configuration backed up to: ${config_backup_dir}"
}

# Health check functions
wait_for_service() {
    local service_name="$1"
    local max_attempts=30
    local attempt=1
    
    log_info "Waiting for ${service_name} to be healthy..."
    
    while [[ $attempt -le $max_attempts ]]; do
        if docker-compose ps "${service_name}" | grep -q "healthy\|Up"; then
            log_success "${service_name} is healthy"
            return 0
        fi
        
        log_info "Attempt ${attempt}/${max_attempts}: ${service_name} not ready yet..."
        sleep 10
        ((attempt++))
    done
    
    log_error "${service_name} failed to become healthy within timeout"
    return 1
}

health_check() {
    log_info "Performing health checks..."
    
    # Check application health
    local health_endpoint="http://localhost:8080/actuator/health"
    local response=$(curl -s -o /dev/null -w "%{http_code}" "${health_endpoint}")
    
    if [[ "${response}" == "200" ]]; then
        log_success "Application health check passed"
    else
        log_error "Application health check failed (HTTP ${response})"
        return 1
    fi
    
    # Check database connectivity
    if docker exec vatm-postgres pg_isready -U query_service_app -d vatm_query_service; then
        log_success "Database connectivity check passed"
    else
        log_error "Database connectivity check failed"
        return 1
    fi
    
    # Check API endpoints
    local api_key="vatm_test_key_2025_001"
    local api_response=$(curl -s -H "X-API-Key: ${api_key}" \
        "http://localhost:8080/api/v1/query/search?flightNumber=VN123&date=2025-09-12" \
        -o /dev/null -w "%{http_code}")
    
    if [[ "${api_response}" == "200" ]]; then
        log_success "API endpoint check passed"
    else
        log_error "API endpoint check failed (HTTP ${api_response})"
        return 1
    fi
}

# Deployment functions
pull_images() {
    log_info "Pulling Docker images..."
    
    docker-compose pull
    
    if [[ $? -eq 0 ]]; then
        log_success "Images pulled successfully"
    else
        log_error "Failed to pull images"
        exit 1
    fi
}

deploy_services() {
    log_info "Deploying services..."
    
    # Set environment variables
    export ENVIRONMENT="${ENVIRONMENT}"
    export VERSION="${VERSION}"
    export COMPOSE_PROJECT_NAME="${PROJECT_NAME}-${ENVIRONMENT}"
    
    # Deploy with docker-compose
    docker-compose -f docker-compose.yml -f "docker-compose.${ENVIRONMENT}.yml" up -d
    
    if [[ $? -eq 0 ]]; then
        log_success "Services deployed successfully"
    else
        log_error "Service deployment failed"
        exit 1
    fi
}

update_configuration() {
    log_info "Updating configuration..."
    
    # Copy environment-specific configuration
    cp "./config/application-${ENVIRONMENT}.yml" "./config/application.yml"
    
    # Update database migration
    docker-compose exec query-service java -jar app.jar --spring.flyway.migrate
    
    log_success "Configuration updated"
}

# Rollback functions
rollback_deployment() {
    if [[ "${ROLLBACK_ENABLED}" == "true" && -f "/tmp/last_backup_file" ]]; then
        log_warning "Rolling back deployment..."
        
        # Stop current services
        docker-compose down
        
        # Restore database backup
        local backup_file=$(cat /tmp/last_backup_file)
        if [[ -f "/backups/${backup_file}" ]]; then
            log_info "Restoring database from backup: ${backup_file}"
            docker exec -i vatm-postgres psql -U query_service_app -d vatm_query_service < "/backups/${backup_file}"
        fi
        
        # Restore previous version
        git checkout HEAD~1
        docker-compose up -d
        
        log_warning "Rollback completed"
    else
        log_error "Rollback is disabled or no backup available"
    fi
}

# Cleanup functions
cleanup_old_images() {
    log_info "Cleaning up old Docker images..."
    
    docker image prune -f
    docker system prune -f
    
    log_success "Cleanup completed"
}

cleanup_old_backups() {
    log_info "Cleaning up old backups (keeping last 10)..."
    
    find /backups -name "backup_${ENVIRONMENT}_*.sql" -type f | \
        head -n -10 | \
        xargs -r rm -f
    
    find /backups -name "config_*" -type d -mtime +30 | \
        xargs -r rm -rf
    
    log_success "Old backups cleaned up"
}

# Main deployment workflow
main() {
    log_info "Starting deployment of ${PROJECT_NAME} v${VERSION} to ${ENVIRONMENT}"
    
    # Validation
    validate_environment
    validate_version
    check_prerequisites
    
    # Pre-deployment
    backup_database
    backup_configuration
    
    # Deployment
    pull_images
    deploy_services
    
    # Wait for services to be ready
    wait_for_service "query-service"
    wait_for_service "postgres"
    wait_for_service "redis"
    
    # Post-deployment
    update_configuration
    
    # Health checks
    if ! health_check; then
        log_error "Health checks failed, initiating rollback..."
        rollback_deployment
        exit 1
    fi
    
    # Cleanup
    cleanup_old_images
    cleanup_old_backups
    
    log_success "Deployment completed successfully!"
    log_info "Service URL: https://query.vatm.vn"
    log_info "Monitoring: https://monitor.vatm.vn"
}

# Error handling
trap 'log_error "Deployment failed at line $LINENO"; rollback_deployment; exit 1' ERR

# Script execution
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
```

#### E.2 Production Monitoring Script (monitor.sh)
```bash
#!/bin/bash

# VATM Query Service Monitoring Script
# Monitors service health, performance, and alerts

set -e

# Configuration
SERVICE_NAME="vatm-query-service"
ALERT_EMAIL="ops@vatm.vn"
SLACK_WEBHOOK="${SLACK_WEBHOOK_URL}"
LOG_FILE="/var/log/vatm/monitoring.log"

# Thresholds
CPU_THRESHOLD=80
MEMORY_THRESHOLD=85
DISK_THRESHOLD=90
RESPONSE_TIME_THRESHOLD=2000
ERROR_RATE_THRESHOLD=5

# Functions
log_message() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${LOG_FILE}"
}

send_alert() {
    local severity="$1"
    local message="$2"
    
    # Email alert
    echo "Subject: [${severity}] VATM Query Service Alert" | \
    echo -e "Time: $(date)\nService: ${SERVICE_NAME}\nMessage: ${message}" | \
    mail -s "VATM Alert" "${ALERT_EMAIL}"
    
    # Slack alert
    if [[ -n "${SLACK_WEBHOOK}" ]]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"[${severity}] ${SERVICE_NAME}: ${message}\"}" \
            "${SLACK_WEBHOOK}"
    fi
    
    log_message "ALERT [${severity}]: ${message}"
}

check_service_health() {
    local health_url="http://localhost:8080/actuator/health"
    local response=$(curl -s -o /dev/null -w "%{http_code}" "${health_url}")
    
    if [[ "${response}" != "200" ]]; then
        send_alert "CRITICAL" "Service health check failed (HTTP ${response})"
        return 1
    fi
    
    return 0
}

check_system_resources() {
    # CPU Usage
    local cpu_usage=$(top -bn1 | grep "Cpu(s)" | sed "s/.*, *\([0-9.]*\)%* id.*/\1/" | awk '{print 100 - $1}')
    if (( $(echo "${cpu_usage} > ${CPU_THRESHOLD}" | bc -l) )); then
        send_alert "WARNING" "High CPU usage: ${cpu_usage}%"
    fi
    
    # Memory Usage
    local memory_usage=$(free | grep Mem | awk '{printf("%.1f", ($3/$2) * 100.0)}')
    if (( $(echo "${memory_usage} > ${MEMORY_THRESHOLD}" | bc -l) )); then
        send_alert "WARNING" "High memory usage: ${memory_usage}%"
    fi
    
    # Disk Usage
    local disk_usage=$(df -h / | awk 'NR==2 {print $5}' | sed 's/%//')
    if [[ "${disk_usage}" -gt "${DISK_THRESHOLD}" ]]; then
        send_alert "WARNING" "High disk usage: ${disk_usage}%"
    fi
}

check_application_metrics() {
    local metrics_url="http://localhost:8080/actuator/metrics"
    
    # Response Time
    local response_time=$(curl -s "${metrics_url}/http.server.requests" | \
        jq -r '.measurements[] | select(.statistic=="MEAN") | .value')
    
    if (( $(echo "${response_time} > ${RESPONSE_TIME_THRESHOLD}" | bc -l) )); then
        send_alert "WARNING" "High response time: ${response_time}ms"
    fi
    
    # Error Rate
    local error_count=$(curl -s "${metrics_url}/http.server.requests" | \
        jq -r '.availableTags[] | select(.tag=="status") | .values[] | select(startswith("5")) | length')
    
    local total_count=$(curl -s "${metrics_url}/http.server.requests" | \
        jq -r '.measurements[] | select(.statistic=="COUNT") | .value')
    
    if [[ "${total_count}" -gt 0 ]]; then
        local error_rate=$(echo "scale=2; ${error_count} * 100 / ${total_count}" | bc)
        if (( $(echo "${error_rate} > ${ERROR_RATE_THRESHOLD}" | bc -l) )); then
            send_alert "WARNING" "High error rate: ${error_rate}%"
        fi
    fi
}

check_database_connectivity() {
    if ! docker exec vatm-postgres pg_isready -U query_service_app -d vatm_query_service; then
        send_alert "CRITICAL" "Database connectivity lost"
        return 1
    fi
    
    return 0
}

generate_daily_report() {
    local report_date=$(date '+%Y-%m-%d')
    local report_file="/var/log/vatm/daily_report_${report_date}.txt"
    
    {
        echo "VATM Query Service Daily Report - ${report_date}"
        echo "================================================"
        echo ""
        echo "Service Status:"
        docker-compose ps
        echo ""
        echo "System Resources:"
        free -h
        df -h
        echo ""
        echo "Application Metrics:"
        curl -s "http://localhost:8080/actuator/metrics/jvm.memory.used"
        echo ""
        echo "Database Status:"
        docker exec vatm-postgres psql -U query_service_app -d vatm_query_service -c "SELECT COUNT(*) as total_flights FROM flight_plans WHERE created_at >= CURRENT_DATE;"
        echo ""
        echo "Recent Errors:"
        tail -50 /var/log/vatm/query-service.log | grep ERROR || echo "No errors found"
    } > "${report_file}"
    
    # Send report via email
    mail -s "VATM Query Service Daily Report - ${report_date}" "${ALERT_EMAIL}" < "${report_file}"
    
    log_message "Daily report generated and sent"
}

# Main monitoring loop
main() {
    log_message "Starting monitoring check..."
    
    # Health checks
    if ! check_service_health; then
        log_message "Service health check failed, attempting restart..."
        docker-compose restart query-service
        sleep 30
        if ! check_service_health; then
            send_alert "CRITICAL" "Service restart failed, manual intervention required"
        fi
    fi
    
    # System resource checks
    check_system_resources
    
    # Application metrics checks
    check_application_metrics
    
    # Database connectivity check
    check_database_connectivity
    
    log_message "Monitoring check completed"
}

# Schedule daily report at midnight
if [[ "$(date +%H:%M)" == "00:00" ]]; then
    generate_daily_report
fi

# Run main monitoring
main "$@"
```

---

## CONCLUSION

This technical specification document provides a comprehensive blueprint for implementing the FF-ICE Query Service for VATM. The document covers all aspects from system architecture and functional requirements to deployment procedures and monitoring strategies.

### Key Deliverables Summary:

1. **Complete System Architecture**: Detailed technical design for a production-ready Query Service
2. **Database Design**: Optimized schema with proper indexing and performance considerations
3. **API Specifications**: RESTful endpoints with complete documentation and examples
4. **Implementation Plan**: Phase-by-phase development approach with realistic timelines
5. **Deployment Architecture**: Production-ready infrastructure design with monitoring
6. **Testing Strategy**: Comprehensive testing approach including performance and security
7. **Maintenance Procedures**: Ongoing support, backup, and troubleshooting guidelines

### Next Steps for VATM:

1. **Team Assembly**: Recruit development team as specified in Section 7.2
2. **Infrastructure Setup**: Prepare development and production environments
3. **Stakeholder Approval**: Present this specification to VATM management
4. **Vendor Evaluation**: If needed, evaluate system integrators for implementation
5. **Project Kick-off**: Begin Phase 1 development according to implementation plan

This specification serves as the foundation for building a robust, scalable, and ICAO-compliant Query Service that will enable VATM's transition from aASP to eASP, supporting Vietnam's aviation modernization goals.

---

**Document Control:**
- **Version**: 1.0
- **Date**: September 12, 2025
- **Author**: Technical Specification Team
- **Approved By**: [To be filled]
- **Next Review Date**: December 12, 2025



**Advice: Bắt đầu với prototype internal, rồi quyết định next step sau!** 🎯
